#!/bin/bash

# Run git-secrets to scan for secrets
git secrets --pre_commit_hook -- "$@"
if [ $? -ne 0 ]; then
    echo "❌ git-secrets detected potential secrets - commit rejected"
    exit 1
fi

# Gitleaks check (better than grep patterns)
if command -v gitleaks &> /dev/null; then
  if ! gitleaks protect --staged; then
    echo "⚠️  Potential secrets detected by gitleaks"
    exit 1
  fi
fi

# Check if any .env files are being committed (except .env.example)
if git diff --cached --name-only | grep -E "^\.env" | grep -v "^\.env\.example$"; then
    echo "❌ ERROR: Attempting to commit .env file!"
    echo "Environment files should never be committed to version control."
    echo "Files detected:"
    git diff --cached --name-only | grep -E "^\.env" | grep -v "^\.env\.example$"
    exit 1
fi


# Run lint-staged (existing husky functionality)
pnpm exec lint-staged